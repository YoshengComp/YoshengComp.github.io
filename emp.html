<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智能員工排班・考勤系統（原型）</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- PouchDB -->
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
  <!-- Day.js for dates -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/plugin/isoWeek.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek)</script>
  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --card-radius:1.25rem }
    body { background: #f7f9fb }
    .navbar-brand b { letter-spacing:.5px }
    .card { border-radius: var(--card-radius); box-shadow:0 8px 24px rgba(18,38,63,0.06) }
    .btn { border-radius: .9rem }
    .badge { border-radius: .7rem }
    .avatar { width:32px;height:32px;border-radius:50%;display:inline-block;background:#e9ecef;vertical-align:middle;margin-right:.5rem }

    /* Scheduler */
    .scheduler-toolbar { gap:.5rem }
    .scheduler { overflow:auto }
    .scheduler table { border-collapse: separate; border-spacing:0; min-width:960px }
    .scheduler th, .scheduler td { border:1px solid #e9ecef; padding:.5rem; vertical-align:top; background:#fff }
    .scheduler th.sticky { position:sticky; top:0; z-index:2; background:#f8fafc }
    .scheduler td.dropzone { min-height:80px }
    .shift-pill { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:.8rem; border:1px dashed #ced4da; cursor:grab; user-select:none }
    .shift-pill[data-type="M"]{ background:#e8f5e9 }
    .shift-pill[data-type="E"]{ background:#fff3e0 }
    .shift-pill[data-type="N"]{ background:#e3f2fd }
    .shift-pill .remove { cursor:pointer }

    .list-slim .list-group-item{ padding:.4rem .6rem }
    .kpi { font-weight:700 }
    .kpi small{ font-weight:400;color:#6c757d }

    .table thead th { background:#f8fafc }

    @media (max-width: 992px){
      .scheduler table { min-width:720px }
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="bi bi-calendar2-check me-2"></i><b>智能排班・考勤</b></a>
    <div class="d-flex align-items-center gap-2">
      <button id="btnSync" class="btn btn-outline-primary btn-sm"><i class="bi bi-arrow-repeat me-1"></i>同步</button>
      <button id="btnBackup" class="btn btn-outline-secondary btn-sm"><i class="bi bi-download me-1"></i>匯出備份</button>
      <label class="btn btn-outline-secondary btn-sm mb-0">
        <i class="bi bi-upload me-1"></i>匯入
        <input id="fileImport" type="file" accept="application/json" hidden>
      </label>
    </div>
  </div>
</nav>

<div class="container-fluid py-3">
  <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="tab-emp" data-bs-toggle="pill" data-bs-target="#pane-emp" type="button">員工</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-shift" data-bs-toggle="pill" data-bs-target="#pane-shift" type="button">排班</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-att" data-bs-toggle="pill" data-bs-target="#pane-att" type="button">打卡</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-stat" data-bs-toggle="pill" data-bs-target="#pane-stat" type="button">統計/報表</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-settings" data-bs-toggle="pill" data-bs-target="#pane-settings" type="button">設定</button></li>
  </ul>

  <div class="tab-content" id="pills-tabContent">

    <!-- 員工管理 -->
    <div class="tab-pane fade show active" id="pane-emp" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">新增/編輯員工</h5>
                <span class="text-muted small">基本資料 / 權限 / 類型</span>
              </div>
              <form id="formEmp" class="row g-2">
                <input type="hidden" id="empId" />
                <div class="col-12">
                  <label class="form-label">姓名</label>
                  <input class="form-control" id="empName" required />
                </div>
                <div class="col-6">
                  <label class="form-label">職位</label>
                  <input class="form-control" id="empTitle" placeholder="店員/櫃檯/主管" />
                </div>
                <div class="col-6">
                  <label class="form-label">部門</label>
                  <input class="form-control" id="empDept" placeholder="門市/倉儲/客服" />
                </div>
                <div class="col-12">
                  <label class="form-label">聯絡方式</label>
                  <input class="form-control" id="empPhone" placeholder="電話或Email" />
                </div>
                <div class="col-6">
                  <label class="form-label">工作類型</label>
                  <select id="empType" class="form-select">
                    <option value="full">全職</option>
                    <option value="part">兼職</option>
                    <option value="shift">輪班</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">權限</label>
                  <select id="empRole" class="form-select">
                    <option value="staff">一般員工</option>
                    <option value="lead">主管</option>
                    <option value="admin">管理員</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">每週工時上限</label>
                  <input type="number" class="form-control" id="empMaxHours" value="40" />
                </div>
                <div class="col-6">
                  <label class="form-label">可上崗位</label>
                  <input class="form-control" id="empSkills" placeholder="以逗號分隔：門市,收銀" />
                </div>
                <div class="col-12">
                  <label class="form-label">休假偏好</label>
                  <input class="form-control" id="empOffPref" placeholder="例：週日,週一" />
                </div>
                <div class="col-12 d-grid">
                  <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>儲存</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">員工清單</h5>
                <div class="input-group" style="max-width:340px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="empSearch" class="form-control" placeholder="搜尋姓名/部門/職位" />
                </div>
              </div>
              <div class="table-responsive">
                <table class="table align-middle" id="tblEmp">
                  <thead>
                    <tr>
                      <th>姓名</th><th>職位</th><th>部門</th><th>類型</th><th>權限</th><th>每週上限</th><th>技能</th><th class="text-end">操作</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 排班管理 -->
    <div class="tab-pane fade" id="pane-shift" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">班別庫</h5>
                <button id="btnAddShift" class="btn btn-sm btn-outline-primary"><i class="bi bi-plus"></i> 新增班別</button>
              </div>
              <ul id="shiftList" class="list-group list-slim mb-3"></ul>
              <hr/>
              <h6 class="mb-2">快速工具</h6>
              <div class="d-grid gap-2">
                <button id="btnAutoWeek" class="btn btn-primary btn-sm"><i class="bi bi-magic me-1"></i>自動生成本週班表</button>
                <button id="btnClearWeek" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash me-1"></i>清空本週</button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-9">
          <div class="card">
            <div class="card-body">
              <div class="d-flex flex-wrap scheduler-toolbar mb-3">
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-secondary" data-view="week" id="btnViewWeek"><i class="bi bi-calendar-week"></i> 週視圖</button>
                  <button class="btn btn-outline-secondary" data-view="month" id="btnViewMonth"><i class="bi bi-calendar-month"></i> 月視圖</button>
                </div>
                <div class="input-group input-group-sm" style="max-width:320px">
                  <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                  <input type="week" id="weekPicker" class="form-control" />
                  <button class="btn btn-outline-secondary" id="btnToday">本週</button>
                </div>
                <div class="ms-auto d-flex align-items-center gap-3">
                  <div><span class="badge" style="background:#e8f5e9">M 早</span> <span class="badge" style="background:#fff3e0">E 中</span> <span class="badge" style="background:#e3f2fd">N 晚</span></div>
                  <button id="btnSaveSchedule" class="btn btn-success btn-sm"><i class="bi bi-check2-circle me-1"></i>儲存班表</button>
                </div>
              </div>
              <div id="scheduler" class="scheduler"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 打卡 -->
    <div class="tab-pane fade" id="pane-att" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Web 打卡</h5>
              <div class="mb-2">目前時間：<span id="nowTime" class="fw-semibold"></span></div>
              <div class="mb-2">
                <label class="form-label">選擇員工</label>
                <select class="form-select" id="attEmp"></select>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" id="btnClockIn"><i class="bi bi-box-arrow-in-right me-1"></i>上班打卡</button>
                <button class="btn btn-outline-primary" id="btnClockOut"><i class="bi bi-box-arrow-left me-1"></i>下班打卡</button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">本月打卡紀錄</h5>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary" id="btnAttRefresh"><i class="bi bi-arrow-clockwise"></i></button>
                  <button class="btn btn-outline-secondary" id="btnAttExport"><i class="bi bi-file-earmark-excel"></i> 匯出Excel</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table" id="tblAtt"><thead><tr><th>日期</th><th>員工</th><th>上班</th><th>下班</th><th>時數</th><th>狀態</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 統計/報表 -->
    <div class="tab-pane fade" id="pane-stat" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">快速指標</h5>
              <div class="row text-center g-3">
                <div class="col-6"><div class="p-3 bg-white rounded shadow-sm"><div class="kpi" id="kpiPresent">0</div><small>出勤天</small></div></div>
                <div class="col-6"><div class="p-3 bg-white rounded shadow-sm"><div class="kpi" id="kpiLate">0</div><small>遲到次</small></div></div>
                <div class="col-6"><div class="p-3 bg-white rounded shadow-sm"><div class="kpi" id="kpiEarly">0</div><small>早退次</small></div></div>
                <div class="col-6"><div class="p-3 bg-white rounded shadow-sm"><div class="kpi" id="kpiAbsence">0</div><small>曠工天</small></div></div>
              </div>
              <hr/>
              <button class="btn btn-outline-secondary w-100" id="btnExportPDF"><i class="bi bi-filetype-pdf me-1"></i> 生成本月 PDF 報表</button>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">班表 vs. 打卡（缺勤提醒）</h5>
                <div class="input-group input-group-sm" style="max-width:320px">
                  <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                  <input type="month" id="compareMonth" class="form-control" />
                  <button class="btn btn-outline-secondary" id="btnCompare">比對</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table" id="tblCompare"><thead><tr><th>日期</th><th>員工</th><th>排班</th><th>出勤</th><th>結果</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 設定 -->
    <div class="tab-pane fade" id="pane-settings" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">系統設定</h5>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">每日上班時間（預設）</label>
                  <input class="form-control" id="cfgStart" value="09:00" />
                </div>
                <div class="col-6">
                  <label class="form-label">每日下班時間（預設）</label>
                  <input class="form-control" id="cfgEnd" value="18:00" />
                </div>
                <div class="col-6">
                  <label class="form-label">遲到容許（分鐘）</label>
                  <input type="number" class="form-control" id="cfgLateGrace" value="5" />
                </div>
                <div class="col-6">
                  <label class="form-label">早退容許（分鐘）</label>
                  <input type="number" class="form-control" id="cfgEarlyGrace" value="5" />
                </div>
                <div class="col-12">
                  <label class="form-label">遠端同步（可填入 CouchDB/Cloudant Endpoint，留白為僅本機）</label>
                  <input class="form-control" id="cfgRemote" placeholder="https://user:pass@host/dbname" />
                </div>
                <div class="col-12 d-grid">
                  <button class="btn btn-primary" id="btnSaveCfg"><i class="bi bi-save me-1"></i>儲存設定</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">資料管理</h5>
              <p class="text-muted small">本系統使用 PouchDB 於瀏覽器本機儲存，亦可選擇同步至遠端 CouchDB 相容伺服器。</p>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-danger" id="btnNuke"><i class="bi bi-exclamation-triangle me-1"></i>清空全部資料</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modals -->
<div class="modal" tabindex="-1" id="modalShift">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">新增班別</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">名稱</label><input class="form-control" id="shiftName" placeholder="早班"/></div>
          <div class="col-3"><label class="form-label">代號</label><input class="form-control" id="shiftCode" maxlength="1" placeholder="M"/></div>
          <div class="col-3"><label class="form-label">崗位</label><input class="form-control" id="shiftSkill" placeholder="門市"/></div>
          <div class="col-6"><label class="form-label">開始</label><input class="form-control" id="shiftStart" value="09:00"/></div>
          <div class="col-6"><label class="form-label">結束</label><input class="form-control" id="shiftEnd" value="18:00"/></div>
          <div class="col-12"><label class="form-label">需求人數</label><input type="number" class="form-control" id="shiftDemand" value="1"/></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="btnShiftSave">儲存</button>
      </div>
    </div>
  </div>
</div>

<script>
// ================== DB & Models ==================
const db = new PouchDB('roster-db');
const COL = { EMP:'emp', SHIFT:'shift', SCHEDULE:'schedule', PUNCH:'punch', CFG:'cfg' };

async function upsert(doc){
  try { const exists = await db.get(doc._id); doc._rev = exists._rev; } catch(e){/*not found*/}
  return db.put(doc);
}

function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9) }

// ================== Config ==================
let cfg = { start:"09:00", end:"18:00", lateGrace:5, earlyGrace:5, remote:"" };
async function loadCfg(){
  try{ const d = await db.get(COL.CFG); cfg = d.value; } catch(e){ await db.put({_id:COL.CFG, value:cfg}); }
  $('#cfgStart').val(cfg.start); $('#cfgEnd').val(cfg.end); $('#cfgLateGrace').val(cfg.lateGrace); $('#cfgEarlyGrace').val(cfg.earlyGrace); $('#cfgRemote').val(cfg.remote);
}
$('#btnSaveCfg').on('click', async()=>{
  cfg = { start:$('#cfgStart').val(), end:$('#cfgEnd').val(), lateGrace:+$('#cfgLateGrace').val(), earlyGrace:+$('#cfgEarlyGrace').val(), remote:$('#cfgRemote').val() };
  await upsert({_id:COL.CFG, value:cfg}); alert('設定已儲存');
});

// ================== Employees ==================
async function listEmp(){
  const res = await db.allDocs({include_docs:true, startkey:COL.EMP, endkey:COL.EMP+'~'});
  let q = ($('#empSearch').val()||'').toLowerCase();
  const rows = res.rows.map(r=>r.doc).filter(d=>{
    const s = [d.name,d.title,d.dept].join(' ').toLowerCase();
    return s.includes(q);
  });
  const tbody = $('#tblEmp tbody').empty();
  rows.forEach(d=>{
    const tr = $('<tr/>');
    tr.append(`<td><span class="avatar"></span>${d.name}</td>`)
      .append(`<td>${d.title||''}</td>`)
      .append(`<td>${d.dept||''}</td>`)
      .append(`<td>${typeLabel(d.type)}</td>`)
      .append(`<td>${roleLabel(d.role)}</td>`)
      .append(`<td>${d.maxHours||40}</td>`)
      .append(`<td>${(d.skills||[]).join(',')}</td>`)
      .append(`<td class="text-end">
        <button class="btn btn-sm btn-outline-primary me-1" data-act="edit" data-id="${d._id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${d._id}"><i class="bi bi-trash"></i></button>
      </td>`);
    tbody.append(tr);
  });
}

function typeLabel(t){ return {full:'全職', part:'兼職', shift:'輪班'}[t]||t }
function roleLabel(r){ return {admin:'管理員', lead:'主管', staff:'一般'}[r]||r }

$('#formEmp').on('submit', async (e)=>{
  e.preventDefault();
  const id = $('#empId').val() || COL.EMP + ':' + uid();
  const doc = {
    _id:id, name:$('#empName').val(), title:$('#empTitle').val(), dept:$('#empDept').val(), phone:$('#empPhone').val(),
    type:$('#empType').val(), role:$('#empRole').val(), maxHours:+$('#empMaxHours').val(),
    skills:($('#empSkills').val()||'').split(',').map(s=>s.trim()).filter(Boolean),
    offPref:($('#empOffPref').val()||'').split(',').map(s=>s.trim()).filter(Boolean)
  };
  await upsert(doc);
  $('#formEmp')[0].reset(); $('#empId').val('');
  listEmp(); loadEmpOptions();
});

$('#tblEmp').on('click','button', async function(){
  const act = $(this).data('act'); const id = $(this).data('id');
  if(act==='edit'){
    const d = await db.get(id);
    $('#empId').val(d._id); $('#empName').val(d.name); $('#empTitle').val(d.title); $('#empDept').val(d.dept); $('#empPhone').val(d.phone);
    $('#empType').val(d.type); $('#empRole').val(d.role); $('#empMaxHours').val(d.maxHours);
    $('#empSkills').val((d.skills||[]).join(',')); $('#empOffPref').val((d.offPref||[]).join(','));
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(act==='del'){
    if(confirm('確定刪除此員工？')){ const d=await db.get(id); await db.remove(d); listEmp(); loadEmpOptions(); }
  }
});
$('#empSearch').on('input', listEmp);

async function loadEmpOptions(){
  const res = await db.allDocs({include_docs:true, startkey:COL.EMP, endkey:COL.EMP+'~'});
  const sel = $('#attEmp').empty();
  res.rows.map(r=>r.doc).forEach(d=> sel.append(`<option value="${d._id}">${d.name}</option>`));
}

// ================== Shift Library ==================
async function listShifts(){
  const res = await db.allDocs({include_docs:true, startkey:COL.SHIFT, endkey:COL.SHIFT+'~'});
  const list = $('#shiftList').empty();
  if(res.rows.length===0){ // default
    await Promise.all([
      upsert({_id:COL.SHIFT+':M', code:'M', name:'早班', start:'09:00', end:'13:00', demand:1, skill:''}),
      upsert({_id:COL.SHIFT+':E', code:'E', name:'中班', start:'13:00', end:'18:00', demand:1, skill:''}),
      upsert({_id:COL.SHIFT+':N', code:'N', name:'晚班', start:'18:00', end:'22:00', demand:1, skill:''})
    ]);
    return listShifts();
  }
  res.rows.map(r=>r.doc).forEach(s=>{
    const li = $(`<li class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <span class="badge me-2" style="background:${s.code==='M'?'#e8f5e9':s.code==='E'?'#fff3e0':'#e3f2fd'}">${s.code}</span>
        <b>${s.name}</b> <span class="text-muted small">${s.start}~${s.end}</span>
        <span class="ms-1 badge text-bg-light">需求 ${s.demand}</span>
        ${s.skill?`<span class="ms-1 badge bg-secondary">${s.skill}</span>`:''}
      </div>
      <div>
        <button class="btn btn-sm btn-outline-primary me-1" data-act="edit" data-id="${s._id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${s._id}"><i class="bi bi-trash"></i></button>
      </div>
    </li>`);
    list.append(li);
  });
}

$('#btnAddShift').on('click', ()=>{ $('#shiftName').val(''); $('#shiftCode').val('M'); $('#shiftStart').val('09:00'); $('#shiftEnd').val('18:00'); $('#shiftDemand').val(1); $('#shiftSkill').val(''); new bootstrap.Modal('#modalShift').show(); });
$('#btnShiftSave').on('click', async ()=>{
  const s = { code:$('#shiftCode').val().toUpperCase(), name:$('#shiftName').val(), start:$('#shiftStart').val(), end:$('#shiftEnd').val(), demand:+$('#shiftDemand').val(), skill:$('#shiftSkill').val() };
  const id = COL.SHIFT+':'+s.code;
  await upsert({_id:id, ...s}); listShifts(); bootstrap.Modal.getInstance(document.getElementById('modalShift')).hide();
});
$('#shiftList').on('click','button', async function(){
  const act=$(this).data('act'), id=$(this).data('id');
  if(act==='edit'){ const s=await db.get(id); $('#shiftName').val(s.name); $('#shiftCode').val(s.code); $('#shiftStart').val(s.start); $('#shiftEnd').val(s.end); $('#shiftDemand').val(s.demand); $('#shiftSkill').val(s.skill||''); new bootstrap.Modal('#modalShift').show(); }
  if(act==='del'){ if(confirm('刪除此班別？')){ const s=await db.get(id); await db.remove(s); listShifts(); } }
});

// ================== Scheduler ==================
function weekRangeFromInput(){
  const val = $('#weekPicker').val();
  let start = dayjs().startOf('isoWeek');
  if(val){
    const [y,w]=val.split('-W');
    // dayjs ISO week: set to Thursday of that week, then startOf isoWeek
    start = dayjs().year(+y).isoWeek(+w).startOf('isoWeek');
  }
  const days = Array.from({length:7},(_,i)=> start.add(i,'day'));
  return {start, days};
}

async function renderWeekView(){
  const {days} = weekRangeFromInput();
  const resEmp = await db.allDocs({include_docs:true, startkey:COL.EMP, endkey:COL.EMP+'~'});
  const resShift = await db.allDocs({include_docs:true, startkey:COL.SHIFT, endkey:COL.SHIFT+'~'});
  const shifts = resShift.rows.map(r=>r.doc);

  const head = ['員工'].concat(days.map(d=>d.format('MM/DD (ddd)')));
  let html = `<table class="table table-bordered"><thead><tr>${head.map(h=>`<th class="sticky">${h}</th>`).join('')}</tr></thead><tbody>`;
  for(const e of resEmp.rows.map(r=>r.doc)){
    html += `<tr><th class="bg-light">${e.name}<div class="text-muted small">${e.title||''}</div></th>`;
    for(const d of days){
      const cellId = `cell-${e._id}-${d.format('YYYYMMDD')}`;
      html += `<td class="dropzone" data-emp="${e._id}" data-date="${d.format('YYYY-MM-DD')}" id="${cellId}"></td>`;
    }
    html += `</tr>`;
  }
  html += `</tbody></table>`;
  $('#scheduler').html(html);

  // load existing schedule
  const resSched = await db.allDocs({include_docs:true, startkey:COL.SCHEDULE, endkey:COL.SCHEDULE+'~'});
  const map = {}; resSched.rows.forEach(r=>{ const s=r.doc; map[s.empId+'_'+s.date]=s; });

  for(const key in map){ const s=map[key]; const td = $(`#cell-${s.empId}-${dayjs(s.date).format('YYYYMMDD')}`); if(td.length){ td.append(renderShiftPill(s.shiftCode,s.empId,s.date)); } }

  // make shift palette draggable from left list
  // (we'll allow drag from created pills only; to add new, click pill from palette)
  $('#shiftList .list-group-item').each(function(){
    $(this).attr('draggable',false); // palette not draggable
  });

  enableDragDrop();
}

function renderShiftPill(code, empId, date){
  return $(`<span class="shift-pill me-1 mb-1" draggable="true" data-type="${code}" data-emp="${empId}" data-date="${date}">
    <i class="bi bi-grip-vertical"></i>${code}
    <i class="bi bi-x ms-1 small text-danger remove"></i>
  </span>`);
}

function enableDragDrop(){
  // drag start
  $(document).on('dragstart', '.shift-pill', function(ev){ ev.originalEvent.dataTransfer.setData('text/plain', JSON.stringify($(this).data())); });
  // allow drop
  $(document).on('dragover', '.dropzone', function(ev){ ev.preventDefault(); $(this).addClass('bg-light'); });
  $(document).on('dragleave', '.dropzone', function(){ $(this).removeClass('bg-light'); });
  // drop
  $(document).on('drop', '.dropzone', async function(ev){
    ev.preventDefault(); $(this).removeClass('bg-light');
    const data = JSON.parse(ev.originalEvent.dataTransfer.getData('text/plain'));
    const empId = $(this).data('emp'); const date=$(this).data('date');
    // move pill to new cell and update/insert schedule
    const code = data.type;
    $(this).append(renderShiftPill(code, empId, date));
    await saveScheduleCell(empId,date,code);
  });
  // remove pill
  $(document).on('click','.shift-pill .remove', async function(){
    const pill = $(this).closest('.shift-pill');
    const {emp,date} = {emp:pill.data('emp'), date:pill.data('date')};
    pill.remove();
    // delete schedule for that emp/date
    const id = `${COL.SCHEDULE}:${emp}:${date}`; try{ const d=await db.get(id); await db.remove(d); }catch(e){}
  });
}

async function saveScheduleCell(empId,date,shiftCode){
  const id = `${COL.SCHEDULE}:${empId}:${date}`;
  const doc = {_id:id, empId, date, shiftCode};
  await upsert(doc);
}

// Auto scheduler (簡化範例：依技能匹配 & 每週工時上限 & 休假偏好，輪替分配)
async function autoScheduleWeek(){
  const {days} = weekRangeFromInput();
  const emp = (await db.allDocs({include_docs:true, startkey:COL.EMP, endkey:COL.EMP+'~'})).rows.map(r=>r.doc);
  const shifts = (await db.allDocs({include_docs:true, startkey:COL.SHIFT, endkey:COL.SHIFT+'~'})).rows.map(r=>r.doc);

  // 建立每人已分配小時統計
  const hours=Object.fromEntries(emp.map(e=>[e._id,0]));

  for(const d of days){
    for(const s of shifts){
      const dur = durationHours(s.start, s.end);
      // 依技能 / 休假偏好 / 工時上限 篩選候選人
      const candidates = emp.filter(e=>{
        const off = (e.offPref||[]).some(k=> d.format('ddd').includes(k) || d.format('週dd')===k );
        const skillOk = !s.skill || (e.skills||[]).includes(s.skill);
        const capOk = (hours[e._id] + dur) <= (e.maxHours||40);
        return !off && skillOk && capOk;
      }).sort((a,b)=> hours[a._id]-hours[b._id]); // 少工時者優先

      const need = s.demand||1;
      for(let i=0;i<need && candidates[i];i++){
        const chosen = candidates[i];
        await saveScheduleCell(chosen._id, d.format('YYYY-MM-DD'), s.code);
        hours[chosen._id] += dur;
      }
    }
  }
  await renderWeekView();
}

function durationHours(start,end){
  const [sh,sm]=start.split(':').map(Number); const [eh,em]=end.split(':').map(Number);
  let m=(eh*60+em)-(sh*60+sm); if(m<0) m+=24*60; return m/60;
}

$('#btnAutoWeek').on('click', autoScheduleWeek);
$('#btnClearWeek').on('click', async ()=>{
  if(!confirm('清空本週班表？')) return;
  const {days}=weekRangeFromInput();
  const startKey = COL.SCHEDULE+':'; const endKey = COL.SCHEDULE+'~';
  const res = await db.allDocs({include_docs:true, startkey:startKey, endkey:endKey});
  const ids = new Set(days.map(d=>d.format('YYYY-MM-DD')));
  const toDel = res.rows.filter(r=> ids.has(r.doc.date) ).map(r=>({_id:r.id, _rev:r.doc._rev, _deleted:true}));
  if(toDel.length) await db.bulkDocs(toDel);
  renderWeekView();
});

$('#btnSaveSchedule').on('click', ()=> alert('已自動保存（每次拖放即寫入）\n此按鈕作為提示用。'));
$('#btnViewWeek').on('click', renderWeekView);
$('#btnViewMonth').on('click', ()=> alert('月視圖（精簡原型）：可擴充為日曆網格 + 叠加班別與人力需求熱度。'));
$('#btnToday').on('click', ()=>{ const y=dayjs().year(); const w=dayjs().isoWeek(); $('#weekPicker').val(`${y}-W${String(w).padStart(2,'0')}`); renderWeekView(); });

// ================== Attendance ==================
function tickNow(){ $('#nowTime').text(dayjs().format('YYYY/MM/DD HH:mm:ss')); }
setInterval(tickNow, 1000); tickNow();

$('#btnClockIn').on('click', ()=> clock('in'));
$('#btnClockOut').on('click', ()=> clock('out'));

async function clock(type){
  const empId=$('#attEmp').val(); const date=dayjs().format('YYYY-MM-DD');
  const id=`${COL.PUNCH}:${empId}:${date}`;
  let doc; try{ doc=await db.get(id); }catch(e){ doc={_id:id, empId, date}; }
  const now=dayjs().format('HH:mm');
  if(type==='in'){ doc.in=now; } else { doc.out=now; }
  await upsert(doc); renderAttTable();
}

async function renderAttTable(){
  const mStart = dayjs().startOf('month'); const mEnd=dayjs().endOf('month');
  const punches = (await db.allDocs({include_docs:true, startkey:COL.PUNCH, endkey:COL.PUNCH+'~'})).rows.map(r=>r.doc).filter(p=> dayjs(p.date).isAfter(mStart.subtract(1,'day')) && dayjs(p.date).isBefore(mEnd.add(1,'day')) );
  const emp = Object.fromEntries((await db.allDocs({include_docs:true, startkey:COL.EMP, endkey:COL.EMP+'~'})).rows.map(r=>[r.doc._id,r.doc.name]));

  const tbody=$('#tblAtt tbody').empty();
  for(const p of punches.sort((a,b)=> a.date.localeCompare(b.date))){
    const hrs = p.in && p.out ? durationHours(p.in,p.out) : 0;
    const st = statusFromPunch(p);
    tbody.append(`<tr><td>${dayjs(p.date).format('MM/DD')}</td><td>${emp[p.empId]||''}</td><td>${p.in||''}</td><td>${p.out||''}</td><td>${hrs.toFixed(2)}</td><td>${st}</td></tr>`)
  }
}
$('#btnAttRefresh').on('click', renderAttTable);
$('#btnAttExport').on('click', exportAttendanceExcel);

function statusFromPunch(p){
  // 簡易判斷：比對設定時間與容許值
  const start = cfg.start, end=cfg.end;
  const lateMin = minsBetween(start, p.in);
  const earlyMin = minsBetween(p.out, end);
  let s=[];
  if(p.in){ if(lateMin>cfg.lateGrace) s.push('遲到'); else s.push('準時'); } else s.push('未打卡');
  if(p.out){ if(earlyMin>cfg.earlyGrace) s.push('早退'); }
  return s.join('/');
}
function minsBetween(a,b){ if(!a||!b) return 0; const [ah,am]=a.split(':').map(Number); const [bh,bm]=b.split(':').map(Number); return (bh*60+bm)-(ah*60+am); }

// ================== Compare & Stats ==================
$('#btnCompare').on('click', compareMonth);
$('#compareMonth').val(dayjs().format('YYYY-MM'));

async function compareMonth(){
  const ym=$('#compareMonth').val();
  const empMap = Object.fromEntries((await db.allDocs({include_docs:true, startkey:COL.EMP, endkey:COL.EMP+'~'})).rows.map(r=>[r.doc._id,r.doc]));
  const sched = (await db.allDocs({include_docs:true, startkey:COL.SCHEDULE, endkey:COL.SCHEDULE+'~'})).rows.map(r=>r.doc).filter(s=> s.date.startsWith(ym));
  const punch = (await db.allDocs({include_docs:true, startkey:COL.PUNCH, endkey:COL.PUNCH+'~'})).rows.map(r=>r.doc).filter(p=> p.date.startsWith(ym));

  const punchKey = new Map(punch.map(p=>[p.empId+'_'+p.date, p]));
  const tbody=$('#tblCompare tbody').empty();
  let kpi={present:0,late:0,early:0,absence:0};

  for(const s of sched){
    const key=s.empId+'_'+s.date; const p=punchKey.get(key);
    const emp=empMap[s.empId];
    let result='缺勤';
    if(p){
      const late = minsBetween(cfg.start, p.in) > cfg.lateGrace;
      const early = minsBetween(p.out, cfg.end) > cfg.earlyGrace;
      if(p.in && p.out){ result = late? (early? '遲到/早退':'遲到') : (early? '早退':'出勤'); }
    }
    if(result.includes('出勤')) kpi.present++;
    if(result.includes('遲到')) kpi.late++;
    if(result.includes('早退')) kpi.early++;
    if(result==='缺勤') kpi.absence++;

    tbody.append(`<tr><td>${dayjs(s.date).format('MM/DD')}</td><td>${emp?.name||''}</td><td>${s.shiftCode}</td><td>${p?`${p.in||''}-${p.out||''}`:'—'}</td><td>${result}</td></tr>`)
  }
  $('#kpiPresent').text(kpi.present); $('#kpiLate').text(kpi.late); $('#kpiEarly').text(kpi.early); $('#kpiAbsence').text(kpi.absence);
}

// ================== Export ==================
function exportAttendanceExcel(){
  const rows=[]; $('#tblAtt tbody tr').each(function(){
    const t=$(this).find('td').map((i,td)=>$(td).text()).get(); rows.push({日期:t[0], 員工:t[1], 上班:t[2], 下班:t[3], 時數:t[4], 狀態:t[5]});
  });
  const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '打卡');
  XLSX.writeFile(wb, `attendance_${dayjs().format('YYYYMM')}.xlsx`);
}

$('#btnExportPDF').on('click', ()=>{
  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  doc.setFontSize(16); doc.text('本月考勤統計', 14, 16);
  doc.setFontSize(11); doc.text(`生成時間：${dayjs().format('YYYY/MM/DD HH:mm')}`, 14, 24);
  // 取 Compare 表格產生
  const headers = [['日期','員工','排班','出勤','結果']];
  const data=[]; $('#tblCompare tbody tr').each(function(){ data.push($(this).find('td').map((i,td)=>$(td).text()).get()); });
  doc.autoTable({ head: headers, body: data, startY: 30 });
  doc.save(`attendance_report_${dayjs().format('YYYYMM')}.pdf`);
});

// ================== Backup / Import ==================
$('#btnBackup').on('click', async ()=>{
  const dump = await db.allDocs({include_docs:true});
  const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:`roster_backup_${dayjs().format('YYYYMMDD_HHmm')}.json`});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
$('#fileImport').on('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const txt = await file.text(); const dump = JSON.parse(txt);
  // wipe then import
  if(confirm('匯入將覆蓋現有資料，確定繼續？')){
    const all = await db.allDocs(); await Promise.all(all.rows.map(r=>db.remove(r.id, r.value.rev)));
    const docs = dump.rows.filter(r=>r.doc && !r.id.startsWith('_')).map(r=>r.doc);
    await db.bulkDocs(docs); alert('匯入完成'); location.reload();
  }
});

// ================== Sync & Nuke ==================
let syncHandler=null;
$('#btnSync').on('click', ()=>{
  if(!cfg.remote){ alert('請先在設定中填入遠端同步位址'); return; }
  if(syncHandler){ syncHandler.cancel(); syncHandler=null; alert('已停止同步'); return; }
  syncHandler = PouchDB.sync('roster-db', cfg.remote, {live:true, retry:true})
    .on('change', info=> console.log('sync change', info))
    .on('paused', err=> console.log('sync paused', err))
    .on('active', ()=> console.log('sync active'))
    .on('denied', err=> console.error('sync denied', err))
    .on('complete', info=> console.log('sync complete', info))
    .on('error', err=> console.error('sync error', err));
  alert('已啟動即時同步');
});

$('#btnNuke').on('click', async ()=>{ if(confirm('⚠️ 確定清空所有資料？')){ await db.destroy(); alert('已清空，重新載入'); location.reload(); } });

// ================== Boot ==================
(async function init(){
  await loadCfg(); await listEmp(); await listShifts(); await loadEmpOptions();
  $('#btnToday').click(); renderAttTable(); compareMonth();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
